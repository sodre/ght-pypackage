name: ght-render-repo
on:
  pull_request:
    branches:
      - ght/master

jobs:
  ght-render-repo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: master

      - name: Get last Merge Commit of the ght/render branch to Master
        id: last-render
        run: |
          last_render=$(git log --merges -1 --grep 'ght/render$' --pretty=format:'%H')
          if [ -z $last_render ]; then
            last_render=master
          fi
          echo "::set-output name=treeish::${last_render}"

      - uses: actions/checkout@v2
        with:
          ref: ${{ steps.last-render.outputs.treeish }}

      - name: Fetch all branches
        run: |
          git fetch --no-tags --prune --depth=1 origin +refs/heads/*:refs/remotes/origin/*

      - name: Prepare tree for re-rendering
        run: |
          git rm -rf .
          git checkout origin/ght/master -- .
          git checkout origin/${{ github.head_ref }} -- .github/ght.yaml

      - name: Set up Python 3.7
        uses: actions/setup-python@v1
        with:
          python-version: 3.7
      - name: Install ght-render dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jinja2 jinja2-cli jinja2-time pyyaml
      - run: |
          .github/bin/ght-render.sh render_tree_structure
          .github/bin/ght-render.sh render_tree_ght_content
          .github/bin/ght-render.sh render_tree_content

      - name: Remove ght workflows
        run: |
          git rm -f .github/workflows/ght-init.yml
          git rm -f .github/workflows/ght-render-repo.yml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: master
          branch: ght/render
          branch-suffix: none
          commit-message: (Re-)Render GitHub Template
          title: (Re-)Render ght/master into master
          reviewers: ${{ github.actor }}
          body: |
            This is it! If this is the first rendering, you should be able to just merge
            the PR as is.

            Otherwise, please review the changes and fix any conflicts before merging.


